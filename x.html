<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProjLib Beta</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    @import url('https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background-color: #181818;
      color: #eee;
      font-family: "Orbitron", sans-serif;
      text-align: center;
    }

    body.light-theme { background: #fff; color: #222; }

    .container {
      display: flex; flex-direction: column; align-items: center; gap: 20px;
      width: 90%; max-width: 1500px; margin: 20px auto; padding: 24px;
      background: rgba(20, 20, 40, 0.9);
      border-radius: 12px;
      box-shadow: 0px 4px 15px rgba(0, 212, 255, 0.5);
    }

    body.light-theme .container {
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    }

    .row {
      display: flex; flex-direction: row; flex-wrap: wrap; gap: 20px;
      align-items: center; justify-content: center; width: 100%; margin-bottom: 16px;
    }

    .select-container {
      display: flex; align-items: center; justify-content: center; gap: 8px; position: relative;
    }

    .select-container select, button, input[type="text"], .select-container option {
      font-family: "Orbitron", sans-serif; font-size: 16px; font-weight: bold;
    }

    .select-container select {
      background: #1a1a2e; color: #fff; border: 2px solid #ffcc00;
      padding: 12px 40px; border-radius: 25px;
      transition: all 0.3s ease-in-out; outline: none; cursor: pointer;
      text-align: center; width: 200px; box-sizing: border-box;
      -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }

    .select-container select:hover {
      background: #505050; color: #ffdd55; border-color: #ffaa00;
    }

    .select-container i {
      pointer-events: none; position: absolute; top: 50%; left: 12px;
      transform: translateY(-50%); font-size: 22px;
    }

    #anime-icon { color: #a855f7; }
    #play-icon { color: #3b82f6; }
    #read-icon { color: #10b981; }
    #watch-icon { color: #ef4444; }
    #daily-icon { color: #f59e0b; }
    #brain-icon { color: #ff6f61; }

    button {
      background: #222244; color: #fff; border: 2px solid #ffcc00;
      padding: 12px 18px; border-radius: 25px; transition: all 0.3s ease-in-out;
      outline: none; cursor: pointer;
    }

    button:hover {
      background: linear-gradient(45deg, #9d00ff, #00d4ff);
      box-shadow: 0px 0px 10px rgba(157, 0, 255, 0.5);
    }

    body.light-theme button:hover {
      background: linear-gradient(45deg, #ffaa00, #ff6600);
      box-shadow: 0px 0px 10px rgba(255, 170, 0, 0.5);
    }

    input[type="text"] {
      background: #1a1a2e; color: #fff; border: 2px solid #ffcc00;
      padding: 12px; border-radius: 25px; width: 450px;
      transition: all 0.3s ease-in-out;
    }

    input[type="text"]:hover { background: #222244; border-color: #ffaa00; }

    body.light-theme input[type="text"] { background: #eee; color: #121212; border-color: #ffaa00; }
    body.light-theme input[type="text"]:hover { background: #ddd; }

    body.light-theme .select-container select { background: #eee; color: #121212; border-color: #ffaa00; }
    body.light-theme .select-container select:hover { background: #ddd; }

    #proxyContainer { position: relative; width: 100%; }

    #proxyFrame {
      width: 1366px; height: 768px; max-width: 100%; max-height: 100%;
      border: 2px solid #00d4ff; box-shadow: 0px 0px 15px rgba(0, 212, 255, 0.4);
      border-radius: 10px; display: none; margin: 0 auto;
    }

    .loadingOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4); display: none; align-items: center; justify-content: center;
      z-index: 9999; border-radius: 10px;
    }

    .loadingOverlay .spinner {
      border: 6px solid #f3f3f3; border-top: 6px solid #ffcc00; border-radius: 50%;
      width: 40px; height: 40px; animation: spin 1s linear infinite;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    body.light-theme .ticker-container { background: #f0f0f0; color: #333; }

    .ticker-container {
      width: 100%; overflow: hidden; white-space: nowrap; position: fixed; bottom: 0;
      font-size: 16px; padding: 10px; color: #ffcc00; background: #222; left: 0;
    }

    .ticker { display: inline-block; animation: scrollTicker 30s linear infinite; }
    .ticker a { color: inherit; text-decoration: none; margin-right: 20px; }

    @keyframes scrollTicker { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

    .form-group {
      margin: 32px 0; display: flex; flex-wrap: wrap; gap: 18px 28px;
      align-items: center; justify-content: center;
    }

    input[type="text"]#currentUrl {
      background: transparent; color: #aaa; border: none; font-size: 15px;
      font-family: "Orbitron", sans-serif; font-weight: 500;
      width: 100%; max-width: 1366px; min-width: 300px; padding: 6px 0 6px 8px;
      margin-bottom: 8px; outline: none; box-shadow: none; pointer-events: none;
      text-align: center; display: block; margin-left: auto; margin-right: auto;
    }

    body.light-theme input[type="text"]#currentUrl { color: #555; }

    #notification {
      position: fixed; bottom: 50px; right: 20px; background-color: #ffcc00; color: #1a1a1a;
      padding: 10px 20px; border-radius: 5px; display: none; z-index: 100;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #notification.show { display: block; animation: fadeinout 4s; }

    @keyframes fadeinout {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }

    @media (max-width: 768px) {
      .container { width: 100%; padding: 12px; }
      .row { flex-direction: column; gap: 12px; }
      .select-container select { width: 100%; }
      input[type="text"] { width: 100%; }
      #proxyFrame {
        width: 100%; height: auto; max-width: 100%; max-height: calc(100vh - 200px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="margin-bottom:20px">ProjLib Beta</h1>

    <div class="row">
      <div class="select-container">
        <i id="brain-icon" class="ri-brain-line"></i>
        <select id="brain"></select>
      </div>

      <div class="select-container">
        <i id="play-icon" class="ri-gamepad-line"></i>
        <select id="play"></select>
      </div>

      <div class="select-container">
        <i id="anime-icon" class="ri-movie-line"></i>
        <select id="anime"></select>
      </div>

      <div class="select-container">
        <i id="read-icon" class="ri-book-open-line"></i>
        <select id="read"></select>
      </div>

      <div class="select-container">
        <i id="watch-icon" class="ri-video-line"></i>
        <select id="watch"></select>
      </div>

      <div class="select-container">
        <i id="daily-icon" class="ri-calendar-line"></i>
        <select id="daily"></select>
      </div>
    </div>

    <div class="form-group" style="margin:20px 0">
      <button type="button" id="homeBtn">Home</button>
      <form id="proxyForm" style="display:inline-block">
        <input type="text" id="urlInput" placeholder="Enter website URL or search term" style="width:450px" />
        <button type="submit">Browse</button>
      </form>
      <button type="button" id="refreshBtn">Refresh</button>
      <button type="button" onclick="projLib.fullscreenProxy()">Fullscreen</button>
      <button type="button" id="toggleTheme">Toggle Theme</button>
    </div>

    <div id="proxyContainer" style="position:relative;margin-top:20px;">
      <input type="text" id="currentUrl" readonly placeholder="Current URL" />
      <div id="initialMessage" style="padding:20px;min-height:600px;display:flex;align-items:center;justify-content:center">
        <div style="text-align:center;color:white">
          <i class="ri-global-line" style="font-size:48px;color:#555"></i>
          <h3>No Website Loaded</h3>
          <p>Enter a URL or click one of the dropdowns to load a website.</p>
        </div>
      </div>

      <div id="loadingOverlay" class="loadingOverlay">
        <div class="spinner"></div>
      </div>

      <iframe id="proxyFrame" allowfullscreen referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

  <div class="ticker-container">
    <div class="ticker">Latest news: Loading...</div>
  </div>

  <div id="notification" style="display: none;"></div>

  <script>
    (function (projLib) {
      'use strict';

      // Defaults (overridden by hubData.json if present)
      let HUB_DATA = null;
      let BLACKLISTED_DOMAINS = [
        "wix.com", "google.com", "youtube.com",
        "facebook.com", "2ix2.com", "sporttvhdonlinetvs.com"
      ];
      let DEFAULT_HOME = "https://archive.org";

      // ---------- Utilities ----------
      projLib.isValidUrl = function (e) {
        try {
          const u = new URL(e.startsWith("http") ? e : "https://" + e);
          return u.hostname.includes(".") || u.hostname === "localhost";
        } catch {
          return false;
        }
      };

      projLib.sanitizeText = function (e) {
        const t = document.createElement("div");
        t.textContent = e;
        return t.innerHTML;
      };

      projLib.fetchWithTimeout = function (url, opts, timeoutMs) {
        opts = opts || {};
        timeoutMs = timeoutMs || 15000;
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        return fetch(url, { ...opts, signal: controller.signal })
          .then(resp => { clearTimeout(timer); return resp; })
          .catch(err => { clearTimeout(timer); throw err; });
      };

      projLib.fetchWithRetry = function (url, opts, retries, timeoutMs) {
        retries = retries === undefined ? 2 : retries;
        timeoutMs = timeoutMs || 15000;
        return projLib.fetchWithTimeout(url, opts, timeoutMs).catch(err => {
          if (retries > 0) return projLib.fetchWithRetry(url, opts, retries - 1, timeoutMs);
          throw err;
        });
      };

      // ---------- RSS / Ticker ----------
      projLib.fetchRSSFeed = function (feedUrl, cacheMs) {
        cacheMs = cacheMs || 600000;
        const key = "rssFeedCache_" + feedUrl;
        const cached = localStorage.getItem(key);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (Date.now() - parsed.timestamp < cacheMs) return Promise.resolve(parsed.data);
          } catch { /* ignore cache parse error */ }
        }
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(feedUrl);
        return projLib.fetchWithRetry(proxy)
          .then(resp => { if (!resp.ok) throw new Error("Network response error"); return resp.json(); })
          .then(data => {
            localStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data: data.contents }));
            return data.contents;
          });
      };

      projLib.updateTicker = function () {
        projLib.fetchRSSFeed("https://www.rtp.pt/noticias/rss/mundo").then(function (xmlStr) {
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlStr, "text/xml");
          const items = xml.getElementsByTagName("item");
          let html = "";
          for (let i = 0; i < items.length; i++) {
            const title = items[i].getElementsByTagName("title")[0];
            const link = items[i].getElementsByTagName("link")[0];
            if (title && link) {
              const safeTitle = projLib.sanitizeText(title.textContent);
              const href = link.textContent;
              html += `<a href="${href}" target="_blank" style="color: inherit; text-decoration: none; margin-right: 20px;">${safeTitle}</a> | `;
            }
          }
          if (html.endsWith(" | ")) html = html.slice(0, -3);
          const tickerEl = document.querySelector(".ticker");
          tickerEl.innerHTML = html;

          const containerWidth = document.querySelector(".ticker-container").offsetWidth;
          const contentWidth = tickerEl.scrollWidth;
          if (contentWidth > containerWidth) {
            const duration = contentWidth / 50;
            tickerEl.style.animationDuration = duration + "s";
          } else {
            tickerEl.style.animation = "none";
          }
        }).catch(function () {
          projLib.notifyUser("Failed to load news feed.");
          document.querySelector(".ticker").innerText = "Failed to load news feed.";
        });
      };

      // ---------- UI helpers ----------
      projLib.notifyUser = function (msg) {
        const t = document.getElementById("notification");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 4000);
      };

      projLib.applyTheme = function (mode) {
        mode === "light"
          ? document.body.classList.add("light-theme")
          : document.body.classList.remove("light-theme");
      };

      projLib.toggleTheme = function () {
        if (document.body.classList.contains("light-theme")) {
          document.body.classList.remove("light-theme");
          localStorage.setItem("theme", "dark");
        } else {
          document.body.classList.add("light-theme");
          localStorage.setItem("theme", "light");
        }
      };

      // ---------- Iframe loading ----------
      projLib.processLoadUrl = function (input) {
        let t = (input || "").trim();
        if (!t) return;

        if (!projLib.isValidUrl(t)) t = "https://www.bing.com/search?q=" + encodeURIComponent(t);
        if (!t.startsWith("http://") && !t.startsWith("https://")) t = "https://" + t;

        document.getElementById("currentUrl").value = t;

        const frame = document.getElementById("proxyFrame");
        frame.removeAttribute("srcdoc");
        frame.style.display = "block";
        document.getElementById("initialMessage").style.display = "none";

        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = "flex";
        frame.onload = function () { overlay.style.display = "none"; };
        frame.onerror = function () { overlay.style.display = "none"; projLib.notifyUser("Failed to load the content."); };

        const parsedUrl = new URL(t);
        const isBlacklisted = (BLACKLISTED_DOMAINS || []).some(domain => parsedUrl.hostname.endsWith(domain));
        if (isBlacklisted) {
          frame.setAttribute('sandbox', 'allow-forms allow-scripts allow-same-origin allow-popups');
        } else {
          frame.removeAttribute('sandbox');
        }
        frame.src = t;
      };

      projLib.fullscreenProxy = function () {
        const e = document.getElementById("proxyFrame");
        if (e.requestFullscreen) e.requestFullscreen();
        else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen();
        else if (e.msRequestFullscreen) e.msRequestFullscreen();
      };

      // ---------- Dynamic hub loading ----------
      projLib.loadHubData = function (path) {
        const cacheKey = "hubDataCache";
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
          try { HUB_DATA = JSON.parse(cached); } catch { HUB_DATA = null; }
        }
        return projLib.fetchWithRetry(path, {}, 2, 10000)
          .then(resp => {
            if (!resp.ok) throw new Error("Failed to fetch hubData.json");
            return resp.json();
          })
          .then(data => {
            HUB_DATA = data;
            localStorage.setItem(cacheKey, JSON.stringify(data));
            if (Array.isArray(data.blacklistedDomains)) BLACKLISTED_DOMAINS = data.blacklistedDomains;
            if (typeof data.defaultHome === "string" && data.defaultHome) DEFAULT_HOME = data.defaultHome;
            return data;
          })
          .catch(() => {
            if (!HUB_DATA) projLib.notifyUser("Could not load hub data; using defaults.");
            return HUB_DATA || { categories: [] };
          });
      };

      projLib.populateDropdowns = function (data) {
        if (!data || !Array.isArray(data.categories)) return;

        data.categories.forEach(cat => {
          const select = document.getElementById(cat.id);
          if (!select) return;

          // Clear and rebuild
          select.innerHTML = "";

          // Placeholder option
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = cat.label || "Select";
          select.appendChild(placeholder);

          // Links
          if (Array.isArray(cat.links)) {
            const frag = document.createDocumentFragment();
            cat.links.forEach(link => {
              if (!link || !link.url || !link.name) return;
              const opt = document.createElement("option");
              opt.value = link.url;
              opt.textContent = link.name;
              frag.appendChild(opt);
            });
            select.appendChild(frag);
          }
        });
      };

      // ---------- Boot ----------
      document.addEventListener("DOMContentLoaded", function () {
        // Theme
        let theme = localStorage.getItem("theme");
        if (theme !== "light" && theme !== "dark") theme = "dark";
        projLib.applyTheme(theme);

        // Ticker
        projLib.updateTicker();
        setInterval(projLib.updateTicker, 600000);

        // Load hub data then initialize UI
        projLib.loadHubData("hubData.json").then(data => {
          projLib.populateDropdowns(data);
          projLib.processLoadUrl(DEFAULT_HOME);
        });

        // Events
        document.getElementById("proxyForm").addEventListener("submit", function (ev) {
          ev.preventDefault();
          const t = document.getElementById("urlInput").value;
          projLib.processLoadUrl(t);
        });

        document.getElementById("homeBtn").addEventListener("click", function () {
          projLib.processLoadUrl(DEFAULT_HOME);
        });

        document.getElementById("refreshBtn").addEventListener("click", function () {
          const e = document.getElementById("currentUrl").value;
          if (e) projLib.processLoadUrl(e);
        });

        document.querySelector(".row").addEventListener("change", function (ev) {
          if (ev.target.tagName.toLowerCase() === "select" && ev.target.value) {
            projLib.processLoadUrl(ev.target.value);
            ev.target.selectedIndex = 0;
          }
        });

        document.getElementById("toggleTheme").addEventListener("click", projLib.toggleTheme);
      });

      window.projLib = projLib;
    })(window.projLib || {});
  </script>
</body>
</html>
